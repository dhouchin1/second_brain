<!DOCTYPE html>
<html>
<head>
    <title>Audio Fix Test</title>
    <script src="https://unpkg.com/wavesurfer.js@6.6.4/dist/wavesurfer.min.js"></script>
</head>
<body>
    <h1>Audio Playback Test</h1>
    <div id="waveform" style="margin: 20px 0; border: 1px solid #ddd; height: 80px;">
        <div class="waveform-loading">Loading audio...</div>
    </div>
    
    <div style="margin: 20px 0;">
        <button id="playPauseBtn">
            <i data-lucide="play"></i>
            <span>Play</span>
        </button>
        <select id="playbackSpeed">
            <option value="0.5">0.5x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
        </select>
    </div>
    
    <div>
        <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
    </div>

    <script>
    // Test with a known audio file
    const audioFilename = '2025-09-05-172909-672560-674596e82799.converted.wav';
    
    class AudioTest {
        constructor() {
            this.audioFilename = audioFilename;
            this.initializeAudioPlayer();
        }
        
        async initializeAudioPlayer() {
            if (!this.audioFilename) return;
            
            try {
                const waveformContainer = document.getElementById('waveform');
                if (!waveformContainer) return;
                
                // Initialize WaveSurfer
                this.waveform = WaveSurfer.create({
                    container: '#waveform',
                    waveColor: '#60a5fa',
                    progressColor: '#3b82f6',
                    height: 80,
                    responsive: true,
                    normalize: true,
                    backend: 'WebAudio',
                    barWidth: 2,
                    barRadius: 1,
                    cursorWidth: 2,
                    cursorColor: '#3b82f6'
                });
                
                // Hide loading indicator when ready
                this.waveform.on('ready', () => {
                    const loading = waveformContainer.querySelector('.waveform-loading');
                    if (loading) {
                        loading.style.display = 'none';
                    }
                    console.log('Audio loaded successfully!');
                });
                
                // Show error state if loading fails
                this.waveform.on('error', (error) => {
                    console.error('Waveform loading error:', error);
                    const loading = waveformContainer.querySelector('.waveform-loading');
                    if (loading) {
                        loading.innerHTML = '<span style="color: red;">Failed to load audio</span>';
                    }
                });
                
                // Fetch audio file with credentials and load as blob
                try {
                    console.log('Fetching audio file with credentials...');
                    const response = await fetch(`/audio/${this.audioFilename}`, {
                        credentials: 'same-origin'
                    });
                    
                    console.log('Audio fetch response:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`Audio fetch failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    console.log('Created blob URL:', audioUrl);
                    
                    this.waveform.load(audioUrl);
                    
                    // Clean up the blob URL when the audio is ready or on error
                    this.waveform.on('destroy', () => {
                        URL.revokeObjectURL(audioUrl);
                    });
                    
                } catch (audioFetchError) {
                    console.error('Failed to fetch audio file:', audioFetchError);
                    const loading = waveformContainer.querySelector('.waveform-loading');
                    if (loading) {
                        loading.innerHTML = '<span style="color: red;">Failed to load audio file</span>';
                    }
                    // Fall back to basic HTML5 audio
                    await this.initializeFallbackAudio();
                    return;
                }
                
                // Setup audio controls
                const playPauseBtn = document.getElementById('playPauseBtn');
                const playIcon = playPauseBtn.querySelector('i');
                const playText = playPauseBtn.querySelector('span');
                
                playPauseBtn.addEventListener('click', () => {
                    if (this.waveform.isPlaying()) {
                        this.waveform.pause();
                        playIcon.setAttribute('data-lucide', 'play');
                        playText.textContent = 'Play';
                    } else {
                        this.waveform.play();
                        playIcon.setAttribute('data-lucide', 'pause');
                        playText.textContent = 'Pause';
                    }
                });
                
                // Playback speed control
                const speedSelect = document.getElementById('playbackSpeed');
                if (speedSelect) {
                    speedSelect.addEventListener('change', (e) => {
                        this.waveform.setPlaybackRate(parseFloat(e.target.value));
                    });
                }
                
                // Time updates
                this.waveform.on('audioprocess', () => this.updateAudioTime());
                this.waveform.on('ready', () => {
                    const duration = this.waveform.getDuration();
                    document.getElementById('totalTime').textContent = this.formatTime(duration);
                });
                
            } catch (error) {
                console.error('Failed to initialize audio player:', error);
                // Fallback to basic HTML5 audio
                await this.initializeFallbackAudio();
            }
        }
        
        async initializeFallbackAudio() {
            const waveformContainer = document.getElementById('waveform');
            if (waveformContainer) {
                try {
                    console.log('Initializing fallback audio...');
                    // Fetch audio file with credentials for fallback audio too
                    const response = await fetch(`/audio/${this.audioFilename}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Audio fetch failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    waveformContainer.innerHTML = `
                        <audio controls style="width: 100%; border-radius: 8px;">
                            <source src="${audioUrl}" type="audio/wav">
                            Your browser does not support audio playback.
                        </audio>
                    `;
                    
                    console.log('Fallback audio initialized successfully');
                    
                } catch (error) {
                    console.error('Failed to load fallback audio:', error);
                    waveformContainer.innerHTML = `
                        <div style="padding: 16px; text-align: center; color: red;">
                            Failed to load audio file: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        updateAudioTime() {
            if (!this.waveform) return;
            
            const current = this.waveform.getCurrentTime();
            document.getElementById('currentTime').textContent = this.formatTime(current);
        }
        
        formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    // Start the test when page loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Starting audio test...');
        new AudioTest();
    });
    </script>
</body>
</html>