{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto px-6 py-10 space-y-8">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-semibold text-slate-100">Snapshot View</h1>
      <p class="text-slate-400 text-sm">Captured on {{ manifest.get('generated_at') or file_metadata.get('extracted_at') }}</p>
    </div>
    <a href="/detail/{{ note.id }}" class="text-sm text-indigo-300 hover:text-indigo-100">← Back to note</a>
  </div>

  <section class="bg-slate-900/60 border border-slate-700 rounded-xl p-6 space-y-4">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold text-white">{{ manifest.get('title') or note.title or 'Snapshot' }}</h2>
        <p class="text-slate-400 text-sm break-all">{{ manifest.get('url') or file_metadata.get('source_url') }}</p>
      </div>
      {% if file_metadata.source_url %}
      <a href="{{ file_metadata.source_url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-slate-800 text-slate-200 text-sm hover:bg-slate-700 transition">
        <i data-lucide="external-link"></i>
        Open Original
      </a>
      {% endif %}
    </div>

    {% if manifest.get('ai_summary') or note.summary %}
    <div class="bg-slate-800/70 border border-slate-700 rounded-lg p-4">
      <h3 class="text-sm font-semibold text-slate-300 uppercase tracking-wide mb-2">Summary</h3>
      <p class="text-slate-200 leading-relaxed">{{ manifest.get('ai_summary') or note.summary }}</p>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-300">
      <div>
        <h4 class="font-semibold text-slate-200 mb-2">Metadata</h4>
        {% set manifest_meta = manifest.get('metadata', {}) %}
        <ul class="space-y-1">
          {% if manifest_meta.get('domain') or file_metadata.get('domain') %}
          <li><span class="text-slate-400">Domain:</span> {{ manifest_meta.get('domain') or file_metadata.get('domain') }}</li>
          {% endif %}
          {% if manifest_meta.get('handler') %}
          <li><span class="text-slate-400">Handler:</span> {{ manifest_meta.get('handler') }}</li>
          {% endif %}
          {% if manifest.get('ai_tags') %}
          <li><span class="text-slate-400">Tags:</span> {{ manifest.get('ai_tags') | join(', ') }}</li>
          {% endif %}
          {% if manifest_meta.get('repo') %}
          <li><span class="text-slate-400">Repo Stars:</span> {{ manifest_meta.get('repo').get('stars') }}</li>
          {% endif %}
        </ul>
      </div>
      <div>
        <h4 class="font-semibold text-slate-200 mb-2">Configuration</h4>
        <ul class="space-y-1 text-slate-300">
          {% if manifest.get('config') %}
            {% for key, value in manifest.get('config').items() %}
              <li><span class="text-slate-400">{{ key.replace('_', ' ') | title }}:</span> {{ value }}</li>
            {% endfor %}
          {% endif %}
        </ul>
      </div>
    </div>
  </section>

  <section class="bg-slate-900/60 border border-slate-700 rounded-xl p-6">
    <h3 class="text-xl font-semibold text-white mb-4">Artifacts</h3>
    {% if artifacts %}
    <div class="space-y-4">
      {% for artifact in artifacts %}
      <div class="border border-slate-700 rounded-lg p-4 bg-slate-900/80">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <p class="text-slate-200 font-medium">{{ artifact.label or artifact.type | title }}</p>
            <p class="text-slate-400 text-xs">{{ artifact.mime_type or 'application/octet-stream' }} • {{ artifact.size or 0 }} bytes</p>
          </div>
          <div class="flex items-center gap-3">
            {% if artifact.inline_url %}
              <a href="{{ artifact.inline_url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-indigo-500 text-white text-sm hover:bg-indigo-400 transition">
                <i data-lucide="monitor"></i>
                Open Preview
              </a>
            {% endif %}
            {% if artifact.view_url %}
              <a href="{{ artifact.view_url }}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-slate-800 text-slate-200 text-sm hover:bg-slate-700 transition">
                <i data-lucide="download"></i>
                Download
              </a>
            {% endif %}
          </div>
        </div>
        {% if artifact.mime_type and artifact.mime_type.startswith('image/') %}
          <img src="{{ artifact.view_url }}" alt="Snapshot image" class="mt-4 rounded-md border border-slate-700 max-h-96" />
        {% elif artifact.mime_type and artifact.mime_type.startswith('video/') %}
          <video controls preload="metadata" class="mt-4 w-full rounded-lg border border-slate-700">
            <source src="{{ artifact.view_url }}" type="{{ artifact.mime_type }}">
            Your browser does not support embedded video.
          </video>
        {% elif artifact.mime_type and artifact.mime_type.startswith('audio/') %}
          <audio controls class="mt-4 w-full">
            <source src="{{ artifact.view_url }}" type="{{ artifact.mime_type }}">
            Your browser does not support audio playback.
          </audio>
        {% elif artifact.mime_type and artifact.mime_type.endswith('pdf') %}
          <iframe src="{{ artifact.view_url }}" class="mt-4 w-full h-[480px] border border-slate-800 rounded-lg" title="PDF preview"></iframe>
        {% endif %}
        {% if artifact.metadata and artifact.metadata.items() %}
        <dl class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-slate-400">
          {% for key, value in artifact.metadata.items() %}
          <div><span class="text-slate-500">{{ key.replace('_', ' ') | title }}:</span> {{ value }}</div>
          {% endfor %}
        </dl>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-slate-400 text-sm">No artifacts were captured for this snapshot.</p>
    {% endif %}
  </section>

  <section class="bg-slate-900/60 border border-slate-700 rounded-xl p-6">
    <h3 class="text-xl font-semibold text-white mb-4">Raw Content</h3>
    <pre class="bg-slate-950/80 border border-slate-800 rounded-lg p-4 text-xs text-slate-300 overflow-x-auto">{{ note.content }}</pre>
  </section>
</div>
{% endblock %}
