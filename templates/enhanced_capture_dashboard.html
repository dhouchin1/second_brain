{% extends 'base.html' %}
{% block title %}Enhanced Capture ‚Äì Second Brain{% endblock %}
{% block head_extra %}
  <link rel="stylesheet" href="/static/css/design-system.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <style>
    body { background: #0f172a; font-family: 'Inter', Arial, sans-serif; }
    
    /* Enhanced capture interface styles */
    .capture-tabs {
      display: flex;
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 24px;
    }
    
    .capture-tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 200ms ease;
      color: #94a3b8;
      font-weight: 500;
      font-size: 14px;
    }
    
    .capture-tab.active {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .capture-tab:hover:not(.active) {
      background: rgba(255,255,255,.08);
      color: #e2e8f0;
    }
    
    .capture-panel {
      display: none;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .capture-panel.active {
      display: block;
      animation: fadeInUp 0.4s ease-out;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Feature card styles */
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .feature-card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 200ms ease;
      position: relative;
      overflow: hidden;
    }
    
    .feature-card:hover {
      background: rgba(255,255,255,.08);
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .feature-card.active {
      border-color: #6366f1;
      background: rgba(99, 102, 241, 0.1);
    }
    
    .feature-icon {
      font-size: 24px;
      margin-bottom: 12px;
      display: block;
    }
    
    .feature-title {
      color: #e2e8f0;
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .feature-description {
      color: #94a3b8;
      font-size: 14px;
      line-height: 1.4;
    }
    
    /* Upload areas */
    .upload-area {
      border: 2px dashed rgba(99, 102, 241, 0.3);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      transition: all 200ms ease;
      background: rgba(99, 102, 241, 0.05);
      cursor: pointer;
    }
    
    .upload-area:hover, .upload-area.drag-over {
      border-color: #6366f1;
      background: rgba(99, 102, 241, 0.1);
    }
    
    .upload-area.processing {
      border-color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }
    
    /* Status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .status-indicator.success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .status-indicator.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .status-indicator.processing {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    /* Button styles */
    .btn {
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 200ms ease;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .btn-secondary {
      background: rgba(255,255,255,.06);
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,.1);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,.1);
      border-color: rgba(255,255,255,.2);
    }
    
    /* Form styles */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      color: #e2e8f0;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-input, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0,0,0,.3);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 14px;
      transition: all 200ms ease;
    }
    
    .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    /* Progress indicators */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,.1);
      border-radius: 2px;
      overflow: hidden;
      margin: 16px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      width: 0%;
      transition: width 300ms ease;
    }
    
    /* Statistics styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #6366f1;
      display: block;
      margin-bottom: 4px;
    }
    
    .stat-label {
      color: #94a3b8;
      font-size: 14px;
    }
    
    /* Recent items list */
    .recent-list {
      background: rgba(255,255,255,.02);
      border-radius: 8px;
      padding: 16px;
    }
    
    .recent-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    
    .recent-item:last-child {
      border-bottom: none;
    }
    
    .recent-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .recent-content {
      flex: 1;
      min-width: 0;
    }
    
    .recent-title {
      color: #e2e8f0;
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .recent-meta {
      color: #94a3b8;
      font-size: 12px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">üß† Enhanced Capture Center</h1>
      <p class="text-slate-400">Advanced content capture with AI-powered processing</p>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="capture-tabs">
      <div class="capture-tab active" data-tab="quick">
        üìù Quick Capture
      </div>
      <div class="capture-tab" data-tab="advanced">
        üöÄ Advanced Capture
      </div>
      <div class="capture-tab" data-tab="shortcuts">
        üì± Apple Shortcuts
      </div>
      <div class="capture-tab" data-tab="discord">
        üí¨ Discord Integration
      </div>
      <div class="capture-tab" data-tab="stats">
        üìä Statistics
      </div>
    </div>
    
    <!-- Quick Capture Panel -->
    <div class="capture-panel active" id="panel-quick">
      <h2 class="text-xl font-semibold text-white mb-6">üìù Quick Text & Voice Capture</h2>
      
      <form id="quickCaptureForm" class="space-y-6">
        <div class="form-group">
          <label class="form-label">Content</label>
          <textarea id="quickContent" class="form-textarea" rows="6" 
                    placeholder="Enter your note, thoughts, or ideas..."></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags (optional)</label>
          <input type="text" id="quickTags" class="form-input" 
                 placeholder="work, meeting, important">
        </div>
        
        <div class="flex gap-4">
          <button type="submit" class="btn btn-primary">
            üíæ Save Note
          </button>
          <button type="button" id="voiceRecordBtn" class="btn btn-secondary">
            üé§ Record Voice
          </button>
        </div>
      </form>
      
      <!-- Voice Recording UI -->
      <div id="voiceRecordingUI" class="hidden mt-6 p-6 border border-red-300 rounded-lg bg-red-50">
        <div class="flex items-center justify-between mb-4">
          <span class="text-red-700 font-medium">üé§ Recording...</span>
          <span id="recordingTimer" class="text-red-600 font-mono">00:00</span>
        </div>
        <div class="flex gap-4">
          <button id="stopRecordingBtn" class="btn btn-primary">Stop Recording</button>
          <button id="cancelRecordingBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
    
    <!-- Advanced Capture Panel -->
    <div class="capture-panel" id="panel-advanced">
      <h2 class="text-xl font-semibold text-white mb-6">üöÄ Advanced Capture Options</h2>
      
      <div class="feature-grid">
        <!-- OCR Screenshot -->
        <div class="feature-card" data-feature="ocr">
          <span class="feature-icon">üì∏</span>
          <div class="feature-title">Screenshot OCR</div>
          <div class="feature-description">Extract text from screenshots and images</div>
        </div>
        
        <!-- PDF Processing -->
        <div class="feature-card" data-feature="pdf">
          <span class="feature-icon">üìÑ</span>
          <div class="feature-title">PDF Extraction</div>
          <div class="feature-description">Extract and process text from PDF documents</div>
        </div>
        
        <!-- URL Processing -->
        <div class="feature-card" data-feature="url">
          <span class="feature-icon">üåê</span>
          <div class="feature-title">Web Content</div>
          <div class="feature-description">Capture and summarize web pages</div>
        </div>
        
        <!-- Bulk Processing -->
        <div class="feature-card" data-feature="bulk">
          <span class="feature-icon">üìö</span>
          <div class="feature-title">Bulk Processing</div>
          <div class="feature-description">Process multiple URLs or files at once</div>
        </div>
      </div>
      
      <!-- Dynamic capture area -->
      <div id="advancedCaptureArea">
        <div class="text-center text-slate-400 py-12">
          üëÜ Select a capture method above to get started
        </div>
      </div>
    </div>
    
    <!-- Apple Shortcuts Panel -->
    <div class="capture-panel" id="panel-shortcuts">
      <h2 class="text-xl font-semibold text-white mb-6">üì± Apple Shortcuts Integration</h2>
      
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div>
          <h3 class="text-lg font-medium text-white mb-4">üéØ Quick Setup</h3>
          <p class="text-slate-400 mb-4">Get started with pre-built shortcuts for iOS and macOS:</p>
          
          <div class="space-y-3">
            <button class="btn btn-primary w-full" onclick="getShortcutTemplate('voice_memo')">
              üé§ Voice Memo Shortcut
            </button>
            <button class="btn btn-primary w-full" onclick="getShortcutTemplate('photo_ocr')">
              üì∏ Photo OCR Shortcut
            </button>
            <button class="btn btn-primary w-full" onclick="getShortcutTemplate('web_clip')">
              üåê Web Clip Shortcut
            </button>
            <button class="btn btn-primary w-full" onclick="getShortcutTemplate('quick_note')">
              üìù Quick Note Shortcut
            </button>
          </div>
        </div>
        
        <div>
          <h3 class="text-lg font-medium text-white mb-4">üìä Usage Stats</h3>
          <div id="shortcutsStats" class="space-y-3">
            <div class="flex justify-between">
              <span class="text-slate-400">Total Captures:</span>
              <span class="text-white font-medium">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">Voice Memos:</span>
              <span class="text-white font-medium">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">Photo OCRs:</span>
              <span class="text-white font-medium">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-slate-400">Web Clips:</span>
              <span class="text-white font-medium">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h4 class="text-blue-800 font-medium mb-2">üí° Setup Instructions</h4>
        <p class="text-blue-700 text-sm">
          Click on any shortcut template above to get the iOS Shortcuts app configuration. 
          Each template includes step-by-step setup instructions and will integrate directly with your Second Brain.
        </p>
      </div>
    </div>
    
    <!-- Discord Integration Panel -->
    <div class="capture-panel" id="panel-discord">
      <h2 class="text-xl font-semibold text-white mb-6">üí¨ Discord Integration</h2>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-medium text-white mb-4">ü§ñ Bot Status</h3>
          <div id="discordStatus" class="mb-6">
            <div class="status-indicator processing">
              <span>‚è≥</span>
              Checking Discord bot status...
            </div>
          </div>
          
          <h4 class="text-md font-medium text-white mb-3">Available Commands:</h4>
          <div class="space-y-2 text-sm">
            <div class="flex gap-3">
              <code class="bg-slate-800 px-2 py-1 rounded text-blue-300">/capture</code>
              <span class="text-slate-400">Save a quick note</span>
            </div>
            <div class="flex gap-3">
              <code class="bg-slate-800 px-2 py-1 rounded text-blue-300">/search</code>
              <span class="text-slate-400">Search your notes</span>
            </div>
            <div class="flex gap-3">
              <code class="bg-slate-800 px-2 py-1 rounded text-blue-300">/thread_summary</code>
              <span class="text-slate-400">Summarize thread</span>
            </div>
            <div class="flex gap-3">
              <code class="bg-slate-800 px-2 py-1 rounded text-blue-300">/meeting_notes</code>
              <span class="text-slate-400">Start meeting notes</span>
            </div>
          </div>
        </div>
        
        <div>
          <h3 class="text-lg font-medium text-white mb-4">üìà Usage Statistics</h3>
          <div id="discordStats" class="stats-grid mb-4">
            <div class="stat-card">
              <span class="stat-value">-</span>
              <span class="stat-label">Total Notes</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">-</span>
              <span class="stat-label">Servers</span>
            </div>
          </div>
          
          <h4 class="text-md font-medium text-white mb-3">üéØ Reaction Shortcuts:</h4>
          <div class="space-y-2 text-sm">
            <div class="flex gap-3">
              <span class="text-xl">üß†</span>
              <span class="text-slate-400">React to save any message</span>
            </div>
            <div class="flex gap-3">
              <span class="text-xl">üìù</span>
              <span class="text-slate-400">React to summarize thread</span>
            </div>
            <div class="flex gap-3">
              <span class="text-xl">‚≠ê</span>
              <span class="text-slate-400">React to mark as important</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Statistics Panel -->
    <div class="capture-panel" id="panel-stats">
      <h2 class="text-xl font-semibold text-white mb-6">üìä Capture Statistics</h2>
      
      <div class="stats-grid mb-6">
        <div class="stat-card">
          <span class="stat-value" id="totalNotes">-</span>
          <span class="stat-label">Total Notes</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="todayNotes">-</span>
          <span class="stat-label">Today</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="weekNotes">-</span>
          <span class="stat-label">This Week</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="avgProcessingTime">-</span>
          <span class="stat-label">Avg Processing Time</span>
        </div>
      </div>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-medium text-white mb-4">üìà Capture Sources</h3>
          <div id="captureSourcesChart" class="recent-list">
            <!-- Dynamic content -->
          </div>
        </div>
        
        <div>
          <h3 class="text-lg font-medium text-white mb-4">üïí Recent Captures</h3>
          <div id="recentCapturesList" class="recent-list">
            <!-- Dynamic content -->
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- Shortcut Template Modal -->
<div id="shortcutTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-90vh overflow-y-auto">
    <div class="p-6 border-b border-slate-700">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-semibold text-white" id="modalTitle">Shortcut Template</h3>
        <button onclick="closeShortcutModal()" class="text-slate-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    <div class="p-6" id="modalContent">
      <!-- Dynamic content -->
    </div>
  </div>
</div>

<script>
// Enhanced Capture Dashboard JavaScript
class EnhancedCaptureDashboard {
  constructor() {
    this.currentTab = 'quick';
    this.isRecording = false;
    this.mediaRecorder = null;
    this.recordingTimer = null;
    this.recordingStartTime = null;
    
    this.init();
  }
  
  init() {
    this.setupTabSwitching();
    this.setupQuickCapture();
    this.setupAdvancedCapture();
    this.loadStatistics();
    this.loadDiscordStatus();
    this.loadShortcutsStats();
  }
  
  setupTabSwitching() {
    document.querySelectorAll('.capture-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const tabName = e.target.dataset.tab;
        this.switchTab(tabName);
      });
    });
  }
  
  switchTab(tabName) {
    // Update tab appearance
    document.querySelectorAll('.capture-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Update panel visibility
    document.querySelectorAll('.capture-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    document.getElementById(`panel-${tabName}`).classList.add('active');
    
    this.currentTab = tabName;
    
    // Load tab-specific data
    if (tabName === 'stats') {
      this.loadStatistics();
    } else if (tabName === 'discord') {
      this.loadDiscordStatus();
    } else if (tabName === 'shortcuts') {
      this.loadShortcutsStats();
    }
  }
  
  setupQuickCapture() {
    const form = document.getElementById('quickCaptureForm');
    const voiceBtn = document.getElementById('voiceRecordBtn');
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await this.submitQuickCapture();
    });
    
    voiceBtn.addEventListener('click', () => {
      this.toggleVoiceRecording();
    });
  }
  
  async submitQuickCapture() {
    const content = document.getElementById('quickContent').value.trim();
    const tags = document.getElementById('quickTags').value.trim();
    
    if (!content) {
      this.showNotification('Please enter some content', 'error');
      return;
    }
    
    try {
      this.showNotification('Saving note...', 'processing');
      
      const response = await fetch('/api/unified-capture/quick-note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
          content: content,
          source: 'web_ui',
          note_type: 'quick_note'
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        this.showNotification('Note saved successfully!', 'success');
        document.getElementById('quickContent').value = '';
        document.getElementById('quickTags').value = '';
        this.loadStatistics(); // Refresh stats
      } else {
        this.showNotification('Failed to save note: ' + result.error, 'error');
      }
    } catch (error) {
      console.error('Quick capture error:', error);
      this.showNotification('Error saving note', 'error');
    }
  }
  
  async toggleVoiceRecording() {
    if (this.isRecording) {
      this.stopRecording();
    } else {
      await this.startRecording();
    }
  }
  
  async startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      this.mediaRecorder = new MediaRecorder(stream);
      const audioChunks = [];
      
      this.mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };
      
      this.mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        await this.processVoiceRecording(audioBlob);
        stream.getTracks().forEach(track => track.stop());
      };
      
      this.mediaRecorder.start();
      this.isRecording = true;
      this.recordingStartTime = Date.now();
      
      // Update UI
      document.getElementById('voiceRecordBtn').textContent = '‚èπÔ∏è Stop Recording';
      document.getElementById('voiceRecordingUI').classList.remove('hidden');
      
      // Start timer
      this.recordingTimer = setInterval(() => {
        const elapsed = Date.now() - this.recordingStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('recordingTimer').textContent = 
          `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
      
    } catch (error) {
      console.error('Recording error:', error);
      this.showNotification('Could not start recording', 'error');
    }
  }
  
  stopRecording() {
    if (this.mediaRecorder && this.isRecording) {
      this.mediaRecorder.stop();
      this.isRecording = false;
      
      // Clear timer
      if (this.recordingTimer) {
        clearInterval(this.recordingTimer);
        this.recordingTimer = null;
      }
      
      // Update UI
      document.getElementById('voiceRecordBtn').textContent = 'üé§ Record Voice';
      document.getElementById('voiceRecordingUI').classList.add('hidden');
    }
  }
  
  async processVoiceRecording(audioBlob) {
    try {
      this.showNotification('Processing voice recording...', 'processing');
      
      const formData = new FormData();
      formData.append('audio_data', audioBlob);
      formData.append('source', 'web_ui');
      
      const response = await fetch('/api/unified-capture/audio', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.success) {
        this.showNotification('Voice note saved!', 'success');
        // Optionally populate the text area with transcription
        if (result.content_preview) {
          document.getElementById('quickContent').value = result.content_preview;
        }
      } else {
        this.showNotification('Failed to process voice: ' + result.error, 'error');
      }
    } catch (error) {
      console.error('Voice processing error:', error);
      this.showNotification('Error processing voice recording', 'error');
    }
  }
  
  setupAdvancedCapture() {
    document.querySelectorAll('.feature-card').forEach(card => {
      card.addEventListener('click', (e) => {
        const feature = e.currentTarget.dataset.feature;
        this.showAdvancedFeature(feature);
      });
    });
  }
  
  showAdvancedFeature(feature) {
    // Update active state
    document.querySelectorAll('.feature-card').forEach(card => {
      card.classList.remove('active');
    });
    document.querySelector(`[data-feature="${feature}"]`).classList.add('active');
    
    // Show appropriate UI
    const captureArea = document.getElementById('advancedCaptureArea');
    
    switch (feature) {
      case 'ocr':
        this.showOCRInterface(captureArea);
        break;
      case 'pdf':
        this.showPDFInterface(captureArea);
        break;
      case 'url':
        this.showURLInterface(captureArea);
        break;
      case 'bulk':
        this.showBulkInterface(captureArea);
        break;
    }
  }
  
  showOCRInterface(container) {
    container.innerHTML = `
      <div class="space-y-6">
        <h3 class="text-lg font-medium text-white">üì∏ Screenshot OCR</h3>
        <div class="upload-area" id="ocrUploadArea">
          <div class="text-center">
            <span class="text-4xl mb-4 block">üì∏</span>
            <p class="text-slate-300 font-medium mb-2">Drop image file here or click to select</p>
            <p class="text-slate-400 text-sm">Supports PNG, JPG, GIF files</p>
            <input type="file" id="ocrFileInput" class="hidden" accept="image/*">
          </div>
        </div>
        <div class="hidden" id="ocrProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="ocrProgressFill"></div>
          </div>
          <p class="text-center text-slate-400 text-sm mt-2">Processing image and extracting text...</p>
        </div>
      </div>
    `;
    
    this.setupFileUpload('ocr');
  }
  
  showPDFInterface(container) {
    container.innerHTML = `
      <div class="space-y-6">
        <h3 class="text-lg font-medium text-white">üìÑ PDF Processing</h3>
        <div class="upload-area" id="pdfUploadArea">
          <div class="text-center">
            <span class="text-4xl mb-4 block">üìÑ</span>
            <p class="text-slate-300 font-medium mb-2">Drop PDF file here or click to select</p>
            <p class="text-slate-400 text-sm">Extract and process text from PDF documents</p>
            <input type="file" id="pdfFileInput" class="hidden" accept=".pdf">
          </div>
        </div>
        <div class="hidden" id="pdfProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="pdfProgressFill"></div>
          </div>
          <p class="text-center text-slate-400 text-sm mt-2">Extracting text from PDF...</p>
        </div>
      </div>
    `;
    
    this.setupFileUpload('pdf');
  }
  
  showURLInterface(container) {
    container.innerHTML = `
      <div class="space-y-6">
        <h3 class="text-lg font-medium text-white">üåê Web Content Capture</h3>
        <form id="urlCaptureForm" class="space-y-4">
          <div class="form-group">
            <label class="form-label">Website URL</label>
            <input type="url" id="urlInput" class="form-input" placeholder="https://example.com" required>
          </div>
          <button type="submit" class="btn btn-primary">
            üåê Capture Website
          </button>
        </form>
        <div class="hidden" id="urlProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="urlProgressFill"></div>
          </div>
          <p class="text-center text-slate-400 text-sm mt-2">Extracting content from website...</p>
        </div>
      </div>
    `;
    
    document.getElementById('urlCaptureForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const url = document.getElementById('urlInput').value;
      await this.captureURL(url);
    });
  }
  
  showBulkInterface(container) {
    container.innerHTML = `
      <div class="space-y-6">
        <h3 class="text-lg font-medium text-white">üìö Bulk Processing</h3>
        <div class="form-group">
          <label class="form-label">URLs (one per line)</label>
          <textarea id="bulkUrlsInput" class="form-textarea" rows="6" 
                    placeholder="https://example1.com
https://example2.com
https://example3.com"></textarea>
        </div>
        <button type="button" onclick="dashboard.processBulkURLs()" class="btn btn-primary">
          üìö Process All URLs
        </button>
        <div class="hidden" id="bulkProgress">
          <div class="progress-bar">
            <div class="progress-fill" id="bulkProgressFill"></div>
          </div>
          <p class="text-center text-slate-400 text-sm mt-2">Processing URLs...</p>
          <div id="bulkResults" class="mt-4"></div>
        </div>
      </div>
    `;
  }
  
  setupFileUpload(type) {
    const uploadArea = document.getElementById(`${type}UploadArea`);
    const fileInput = document.getElementById(`${type}FileInput`);
    
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        this.processFile(files[0], type);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        this.processFile(e.target.files[0], type);
      }
    });
  }
  
  async processFile(file, type) {
    try {
      document.getElementById(`${type}Progress`).classList.remove('hidden');
      document.getElementById(`${type}UploadArea`).classList.add('processing');
      
      const formData = new FormData();
      if (type === 'ocr') {
        // Convert to base64 for image
        const base64 = await this.fileToBase64(file);
        const response = await fetch('/api/unified-capture/image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image_data: base64,
            source: 'web_ui'
          })
        });
        
        const result = await response.json();
        this.handleCaptureResult(result, 'OCR');
        
      } else if (type === 'pdf') {
        const base64 = await this.fileToBase64(file);
        const response = await fetch('/api/unified-capture/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            file_data: base64,
            filename: file.name,
            source: 'web_ui'
          })
        });
        
        const result = await response.json();
        this.handleCaptureResult(result, 'PDF');
      }
      
    } catch (error) {
      console.error('File processing error:', error);
      this.showNotification('Error processing file', 'error');
    } finally {
      document.getElementById(`${type}Progress`).classList.add('hidden');
      document.getElementById(`${type}UploadArea`).classList.remove('processing');
    }
  }
  
  async captureURL(url) {
    try {
      document.getElementById('urlProgress').classList.remove('hidden');
      
      const response = await fetch('/api/unified-capture/url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: url,
          source: 'web_ui'
        })
      });
      
      const result = await response.json();
      this.handleCaptureResult(result, 'URL');
      
    } catch (error) {
      console.error('URL capture error:', error);
      this.showNotification('Error capturing URL', 'error');
    } finally {
      document.getElementById('urlProgress').classList.add('hidden');
    }
  }
  
  async processBulkURLs() {
    const urlsText = document.getElementById('bulkUrlsInput').value.trim();
    if (!urlsText) {
      this.showNotification('Please enter some URLs', 'error');
      return;
    }
    
    const urls = urlsText.split('\n').filter(url => url.trim());
    if (urls.length === 0) {
      this.showNotification('No valid URLs found', 'error');
      return;
    }
    
    try {
      document.getElementById('bulkProgress').classList.remove('hidden');
      
      // Prepare batch request
      const requests = urls.map(url => ({
        content_type: 'url',
        source: 'web_ui',
        url: url.trim(),
        content: ''
      }));
      
      const response = await fetch('/api/unified-capture/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          requests: requests
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        this.showNotification(`Processed ${result.successful}/${result.total_requests} URLs`, 'success');
        this.showBulkResults(result.results);
      } else {
        this.showNotification('Bulk processing failed', 'error');
      }
      
    } catch (error) {
      console.error('Bulk processing error:', error);
      this.showNotification('Error processing URLs', 'error');
    } finally {
      document.getElementById('bulkProgress').classList.add('hidden');
    }
  }
  
  showBulkResults(results) {
    const container = document.getElementById('bulkResults');
    container.innerHTML = results.map(result => `
      <div class="flex justify-between items-center p-2 border-b border-slate-700">
        <span class="text-sm text-slate-300">${result.index + 1}</span>
        <div class="flex-1 mx-3">
          ${result.title ? `<div class="text-sm text-white">${result.title}</div>` : ''}
          ${result.error ? `<div class="text-xs text-red-400">${result.error}</div>` : ''}
        </div>
        <span class="${result.success ? 'text-green-400' : 'text-red-400'}">
          ${result.success ? '‚úÖ' : '‚ùå'}
        </span>
      </div>
    `).join('');
  }
  
  handleCaptureResult(result, type) {
    if (result.success) {
      this.showNotification(`${type} processed successfully!`, 'success');
      this.loadStatistics(); // Refresh stats
    } else {
      this.showNotification(`${type} processing failed: ${result.error}`, 'error');
    }
  }
  
  async loadStatistics() {
    try {
      const response = await fetch('/api/unified-capture/stats');
      const result = await response.json();
      
      if (result.success) {
        const stats = result.data;
        document.getElementById('totalNotes').textContent = stats.total_requests || '0';
        document.getElementById('todayNotes').textContent = '0'; // Would need backend support
        document.getElementById('weekNotes').textContent = '0'; // Would need backend support
        document.getElementById('avgProcessingTime').textContent = 
          `${stats.average_processing_time?.toFixed(2) || '0.00'}s`;
        
        // Update sources chart
        this.updateSourcesChart(stats.by_source || {});
      }
    } catch (error) {
      console.error('Stats loading error:', error);
    }
  }
  
  updateSourcesChart(sources) {
    const container = document.getElementById('captureSourcesChart');
    const entries = Object.entries(sources);
    
    if (entries.length === 0) {
      container.innerHTML = '<div class="text-center text-slate-400 py-4">No data available</div>';
      return;
    }
    
    container.innerHTML = entries.map(([source, count]) => `
      <div class="recent-item">
        <div class="recent-icon bg-blue-500">üìä</div>
        <div class="recent-content">
          <div class="recent-title">${source.replace('_', ' ').toUpperCase()}</div>
          <div class="recent-meta">${count} captures</div>
        </div>
      </div>
    `).join('');
  }
  
  async loadDiscordStatus() {
    try {
      const response = await fetch('/api/discord/health'); // Would need to implement
      const result = await response.json();
      
      const statusEl = document.getElementById('discordStatus');
      if (result.success) {
        statusEl.innerHTML = `
          <div class="status-indicator success">
            <span>‚úÖ</span>
            Discord bot is online and ready
          </div>
        `;
      } else {
        statusEl.innerHTML = `
          <div class="status-indicator error">
            <span>‚ùå</span>
            Discord bot is offline
          </div>
        `;
      }
      
      // Load Discord stats
      const statsResponse = await fetch('/api/discord/stats'); // Would need to implement
      // Update Discord stats display
      
    } catch (error) {
      document.getElementById('discordStatus').innerHTML = `
        <div class="status-indicator error">
          <span>‚ùå</span>
          Could not check Discord status
        </div>
      `;
    }
  }
  
  async loadShortcutsStats() {
    try {
      const response = await fetch('/api/shortcuts/stats');
      const result = await response.json();
      
      if (result.success) {
        const stats = result.data;
        const statsContainer = document.getElementById('shortcutsStats');
        
        statsContainer.innerHTML = `
          <div class="flex justify-between">
            <span class="text-slate-400">Total Captures:</span>
            <span class="text-white font-medium">${stats.total_shortcuts_notes || 0}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Voice Memos:</span>
            <span class="text-white font-medium">${stats.content_types?.voice_memo || 0}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Photo OCRs:</span>
            <span class="text-white font-medium">${stats.content_types?.photo_ocr || 0}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">Web Clips:</span>
            <span class="text-white font-medium">${stats.content_types?.web_clip || 0}</span>
          </div>
        `;
      }
    } catch (error) {
      console.error('Shortcuts stats loading error:', error);
    }
  }
  
  fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = error => reject(error);
    });
  }
  
  showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
      type === 'success' ? 'bg-green-500 text-white' :
      type === 'error' ? 'bg-red-500 text-white' :
      type === 'processing' ? 'bg-yellow-500 text-white' :
      'bg-blue-500 text-white'
    }`;
    
    notification.innerHTML = `
      <div class="flex items-center gap-2">
        <span>${
          type === 'success' ? '‚úÖ' :
          type === 'error' ? '‚ùå' :
          type === 'processing' ? '‚è≥' : '‚ÑπÔ∏è'
        }</span>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }
}

// Shortcut template functions
async function getShortcutTemplate(type) {
  try {
    const response = await fetch('/api/shortcuts/templates');
    const result = await response.json();
    
    if (result.success) {
      const template = result.templates.find(t => t.type === type);
      if (template) {
        showShortcutModal(template);
      } else {
        dashboard.showNotification('Template not found', 'error');
      }
    } else {
      dashboard.showNotification('Could not load templates', 'error');
    }
  } catch (error) {
    console.error('Template loading error:', error);
    dashboard.showNotification('Error loading template', 'error');
  }
}

function showShortcutModal(template) {
  document.getElementById('modalTitle').textContent = template.name;
  document.getElementById('modalContent').innerHTML = `
    <div class="space-y-4">
      <p class="text-slate-300">${template.description}</p>
      
      <div class="bg-slate-700 rounded-lg p-4">
        <h4 class="font-medium text-white mb-2">üì± Setup Instructions:</h4>
        <ol class="list-decimal list-inside space-y-2 text-sm text-slate-300">
          ${template.instructions.map(step => `<li>${step}</li>`).join('')}
        </ol>
      </div>
      
      <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-4">
        <h4 class="font-medium text-blue-200 mb-2">üîó API Endpoint:</h4>
        <code class="text-blue-300 text-sm bg-slate-800 px-2 py-1 rounded">${template.endpoint}</code>
      </div>
      
      <div class="flex gap-3">
        <button onclick="copyToClipboard('${template.endpoint}')" class="btn btn-primary">
          üìã Copy Endpoint
        </button>
        <button onclick="window.open('${template.shortcut_url}', '_blank')" class="btn btn-secondary">
          üì± Open in Shortcuts
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('shortcutTemplateModal').classList.remove('hidden');
}

function closeShortcutModal() {
  document.getElementById('shortcutTemplateModal').classList.add('hidden');
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    dashboard.showNotification('Copied to clipboard!', 'success');
  });
}

// Initialize dashboard
let dashboard;
document.addEventListener('DOMContentLoaded', () => {
  dashboard = new EnhancedCaptureDashboard();
});
</script>

{% endblock %}