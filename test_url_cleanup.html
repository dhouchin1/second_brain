<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Cleanup System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .test-pass { border-color: #10b981; background-color: #f0fdf4; }
        .test-fail { border-color: #ef4444; background-color: #fef2f2; }
        .test-pending { border-color: #f59e0b; background-color: #fffbeb; }
        .code-block { background: #f3f4f6; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">üß™ URL Cleanup System Test Suite</h1>

        <!-- Test Results Display -->
        <div id="testResults" class="space-y-4">
            <!-- Tests will be inserted here -->
        </div>

        <!-- Manual Testing Controls -->
        <div class="mt-8 p-6 bg-white rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Manual Testing Controls</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Search Testing -->
                <div class="space-y-2">
                    <h3 class="font-medium">Search Testing</h3>
                    <input type="text" id="testSearchInput" placeholder="Enter search query" class="w-full p-2 border rounded">
                    <button onclick="testSearch()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Test Search</button>
                    <div id="searchResults" class="text-sm text-gray-600"></div>
                </div>

                <!-- Navigation Testing -->
                <div class="space-y-2">
                    <h3 class="font-medium">Navigation Testing</h3>
                    <button onclick="testNavigation('/search')" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Navigate to Search</button>
                    <button onclick="testNavigation('/analytics')" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Navigate to Analytics</button>
                    <button onclick="testNavigation('/')" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Navigate to Dashboard</button>
                    <div id="navigationResults" class="text-sm text-gray-600"></div>
                </div>

                <!-- State Testing -->
                <div class="space-y-2">
                    <h3 class="font-medium">State Management Testing</h3>
                    <button onclick="testStateOperations()" class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600">Test State Operations</button>
                    <button onclick="testStatePersistence()" class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600">Test State Persistence</button>
                    <div id="stateResults" class="text-sm text-gray-600"></div>
                </div>

                <!-- URL Testing -->
                <div class="space-y-2">
                    <h3 class="font-medium">URL Cleanup Testing</h3>
                    <button onclick="testUrlCleaning()" class="w-full bg-orange-500 text-white p-2 rounded hover:bg-orange-600">Test URL Cleaning</button>
                    <button onclick="simulateOldUrlPatterns()" class="w-full bg-orange-500 text-white p-2 rounded hover:bg-orange-600">Simulate Old URL Patterns</button>
                    <div id="urlResults" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- Current State Display -->
        <div class="mt-8 p-6 bg-white rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Current System State</h2>
            <div id="currentState" class="code-block">
                <!-- State will be displayed here -->
            </div>
            <button onclick="refreshStateDisplay()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Refresh State</button>
        </div>
    </div>

    <!-- Include our state management scripts -->
    <script src="/static/js/state-manager.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/url-cleanup-patch.js"></script>

    <script>
        // Test framework
        class TestRunner {
            constructor() {
                this.tests = [];
                this.results = [];
            }

            addTest(name, description, testFn) {
                this.tests.push({ name, description, testFn });
            }

            async runTests() {
                const resultsContainer = document.getElementById('testResults');
                resultsContainer.innerHTML = '<h2 class="text-xl font-semibold mb-4">Running Tests...</h2>';

                for (const test of this.tests) {
                    try {
                        const result = await test.testFn();
                        this.results.push({ ...test, passed: result.passed, message: result.message });
                    } catch (error) {
                        this.results.push({ ...test, passed: false, message: `Error: ${error.message}` });
                    }
                }

                this.displayResults();
            }

            displayResults() {
                const resultsContainer = document.getElementById('testResults');
                let html = '<h2 class="text-xl font-semibold mb-4">Test Results</h2>';

                this.results.forEach((result, index) => {
                    const statusClass = result.passed ? 'test-pass' : 'test-fail';
                    const statusIcon = result.passed ? '‚úÖ' : '‚ùå';

                    html += `
                        <div class="test-section ${statusClass}">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-medium">${statusIcon} ${result.name}</h3>
                                <span class="text-sm ${result.passed ? 'text-green-600' : 'text-red-600'}">
                                    ${result.passed ? 'PASS' : 'FAIL'}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${result.description}</p>
                            <div class="code-block text-sm">${result.message}</div>
                        </div>
                    `;
                });

                const passCount = this.results.filter(r => r.passed).length;
                const totalCount = this.results.length;

                html += `
                    <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                        <h3 class="font-semibold">Summary: ${passCount}/${totalCount} tests passed</h3>
                        <div class="w-full bg-gray-300 rounded-full h-2 mt-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${(passCount/totalCount)*100}%"></div>
                        </div>
                    </div>
                `;

                resultsContainer.innerHTML = html;
            }
        }

        // Initialize test runner
        const testRunner = new TestRunner();

        // Test 1: State Manager Initialization
        testRunner.addTest(
            'State Manager Initialization',
            'Verify that StateManager initializes correctly with default state',
            async () => {
                if (!window.stateManager) {
                    return { passed: false, message: 'StateManager not found on window object' };
                }

                const state = window.stateManager.getState();
                const requiredKeys = ['currentView', 'searchQuery', 'searchResults', 'selectedNote', 'isOnline'];

                for (const key of requiredKeys) {
                    if (!(key in state)) {
                        return { passed: false, message: `Missing required state key: ${key}` };
                    }
                }

                return {
                    passed: true,
                    message: `StateManager initialized with keys: ${Object.keys(state).join(', ')}`
                };
            }
        );

        // Test 2: Navigation Manager
        testRunner.addTest(
            'Navigation Manager Initialization',
            'Verify that NavigationManager initializes and sets up routes',
            async () => {
                if (!window.navigationManager) {
                    return { passed: false, message: 'NavigationManager not found on window object' };
                }

                const hasRoutes = window.navigationManager.routes && window.navigationManager.routes.size > 0;
                if (!hasRoutes) {
                    return { passed: false, message: 'NavigationManager has no routes defined' };
                }

                return {
                    passed: true,
                    message: `NavigationManager initialized with ${window.navigationManager.routes.size} routes`
                };
            }
        );

        // Test 3: URL Cleanup
        testRunner.addTest(
            'URL Cleanup Functionality',
            'Verify that URLs are cleaned of query parameters',
            async () => {
                const originalUrl = window.location.href;

                // Add test parameters to URL
                const testUrl = new URL(window.location);
                testUrl.searchParams.set('q', 'test-query');
                testUrl.searchParams.set('id', '123');
                testUrl.searchParams.set('action', 'test');

                window.history.replaceState({}, document.title, testUrl.toString());

                // Trigger URL cleanup
                if (window.stateManager && window.stateManager.cleanUrl) {
                    window.stateManager.cleanUrl();
                }

                const cleanedUrl = window.location.href;
                const hasParams = new URL(cleanedUrl).search !== '';

                // Restore original URL
                window.history.replaceState({}, document.title, originalUrl);

                return {
                    passed: !hasParams,
                    message: hasParams ?
                        `URL still has parameters: ${cleanedUrl}` :
                        `URL successfully cleaned: ${cleanedUrl}`
                };
            }
        );

        // Test 4: State Persistence
        testRunner.addTest(
            'State Persistence',
            'Verify that appropriate state is persisted to localStorage',
            async () => {
                if (!window.stateManager) {
                    return { passed: false, message: 'StateManager not available' };
                }

                // Test data
                const testQuery = 'test-search-query-' + Date.now();
                const testPrefs = { theme: 'dark', autoSave: true };

                // Set state
                window.stateManager.setState({
                    searchHistory: [testQuery],
                    preferences: testPrefs
                });

                // Force save
                window.stateManager.savePersistentState();

                // Check localStorage
                const savedHistory = localStorage.getItem('second_brain_searchHistory');
                const savedPrefs = localStorage.getItem('second_brain_preferences');

                if (!savedHistory || !savedPrefs) {
                    return { passed: false, message: 'State not persisted to localStorage' };
                }

                const parsedHistory = JSON.parse(savedHistory);
                const parsedPrefs = JSON.parse(savedPrefs);

                const historyMatch = parsedHistory.includes(testQuery);
                const prefsMatch = parsedPrefs.theme === 'dark';

                // Cleanup
                localStorage.removeItem('second_brain_searchHistory');
                localStorage.removeItem('second_brain_preferences');

                return {
                    passed: historyMatch && prefsMatch,
                    message: `History match: ${historyMatch}, Prefs match: ${prefsMatch}`
                };
            }
        );

        // Test 5: Search State Management
        testRunner.addTest(
            'Search State Management',
            'Verify search operations work without URL pollution',
            async () => {
                if (!window.stateManager) {
                    return { passed: false, message: 'StateManager not available' };
                }

                const testQuery = 'test-search-' + Date.now();
                const testFilters = { type: 'audio', date: '2024-01-01' };

                // Perform search
                window.stateManager.setSearch(testQuery, testFilters);

                const state = window.stateManager.getState();

                const queryMatch = state.searchQuery === testQuery;
                const filtersMatch = JSON.stringify(state.searchFilters) === JSON.stringify(testFilters);

                // Check URL hasn't changed
                const urlHasParams = new URL(window.location).search !== '';

                return {
                    passed: queryMatch && filtersMatch && !urlHasParams,
                    message: `Query: ${queryMatch}, Filters: ${filtersMatch}, Clean URL: ${!urlHasParams}`
                };
            }
        );

        // Test 6: Note State Management
        testRunner.addTest(
            'Note State Management',
            'Verify note operations work with state management',
            async () => {
                if (!window.stateManager) {
                    return { passed: false, message: 'StateManager not available' };
                }

                const testNote = {
                    id: 'test-note-' + Date.now(),
                    title: 'Test Note',
                    content: 'Test content',
                    tags: 'test,note'
                };

                // Select note
                window.stateManager.selectNote(testNote);

                const state = window.stateManager.getState();

                const noteSelected = state.selectedNote && state.selectedNote.id === testNote.id;
                const modalOpen = state.noteModalOpen === true;

                // Check URL hasn't changed
                const urlHasParams = new URL(window.location).search !== '';

                // Close note
                window.stateManager.closeNote();
                const modalClosed = window.stateManager.getState('noteModalOpen') === false;

                return {
                    passed: noteSelected && modalOpen && !urlHasParams && modalClosed,
                    message: `Note selected: ${noteSelected}, Modal opened: ${modalOpen}, Clean URL: ${!urlHasParams}, Modal closed: ${modalClosed}`
                };
            }
        );

        // Test 7: Backwards Compatibility
        testRunner.addTest(
            'Backwards Compatibility',
            'Verify that clean functions exist and work as replacements',
            async () => {
                const cleanFunctions = [
                    'performSearchClean',
                    'viewNoteClean',
                    'handleNoteSubmitClean',
                    'navigateClean'
                ];

                const missing = [];
                const working = [];

                for (const funcName of cleanFunctions) {
                    if (typeof window[funcName] === 'function') {
                        working.push(funcName);
                    } else {
                        missing.push(funcName);
                    }
                }

                return {
                    passed: missing.length === 0,
                    message: `Working: [${working.join(', ')}], Missing: [${missing.join(', ')}]`
                };
            }
        );

        // Manual test functions
        function testSearch() {
            const query = document.getElementById('testSearchInput').value;
            const resultsDiv = document.getElementById('searchResults');

            if (!query.trim()) {
                resultsDiv.textContent = 'Please enter a search query';
                return;
            }

            if (window.performSearchClean) {
                window.performSearchClean(query);
                const state = window.stateManager.getState();
                resultsDiv.innerHTML = `
                    <strong>Search performed:</strong><br>
                    Query: ${state.searchQuery}<br>
                    URL: ${window.location.href}<br>
                    Has URL params: ${new URL(window.location).search !== ''}
                `;
            } else {
                resultsDiv.textContent = 'performSearchClean function not available';
            }
        }

        function testNavigation(path) {
            const resultsDiv = document.getElementById('navigationResults');

            if (window.navigationManager) {
                const beforeUrl = window.location.href;
                window.navigationManager.navigateTo(path);
                const afterUrl = window.location.href;

                resultsDiv.innerHTML = `
                    <strong>Navigation test:</strong><br>
                    Before: ${beforeUrl}<br>
                    After: ${afterUrl}<br>
                    State view: ${window.stateManager.getState('currentView')}
                `;
            } else {
                resultsDiv.textContent = 'NavigationManager not available';
            }
        }

        function testStateOperations() {
            const resultsDiv = document.getElementById('stateResults');

            if (!window.stateManager) {
                resultsDiv.textContent = 'StateManager not available';
                return;
            }

            // Test various state operations
            const testData = {
                searchQuery: 'test-query-' + Date.now(),
                currentView: 'test-view',
                customData: { test: true }
            };

            window.stateManager.setState(testData);
            const retrievedState = window.stateManager.getState();

            const matches = Object.keys(testData).every(key =>
                retrievedState[key] === testData[key] ||
                JSON.stringify(retrievedState[key]) === JSON.stringify(testData[key])
            );

            resultsDiv.innerHTML = `
                <strong>State operations test:</strong><br>
                Data set successfully: ${matches}<br>
                Current state keys: ${Object.keys(retrievedState).length}<br>
                Test data preserved: ${matches ? 'Yes' : 'No'}
            `;
        }

        function testStatePersistence() {
            const resultsDiv = document.getElementById('stateResults');

            if (!window.stateManager) {
                resultsDiv.textContent = 'StateManager not available';
                return;
            }

            const testHistory = ['test1', 'test2', 'test3'];
            window.stateManager.setState({ searchHistory: testHistory });
            window.stateManager.savePersistentState();

            const saved = localStorage.getItem('second_brain_searchHistory');
            const parsed = saved ? JSON.parse(saved) : null;
            const matches = parsed && JSON.stringify(parsed) === JSON.stringify(testHistory);

            // Cleanup
            localStorage.removeItem('second_brain_searchHistory');

            resultsDiv.innerHTML = `
                <strong>Persistence test:</strong><br>
                Data saved to localStorage: ${saved ? 'Yes' : 'No'}<br>
                Data matches: ${matches ? 'Yes' : 'No'}<br>
                Cleaned up: Yes
            `;
        }

        function testUrlCleaning() {
            const resultsDiv = document.getElementById('urlResults');
            const originalUrl = window.location.href;

            // Add test parameters
            const testUrl = new URL(window.location);
            testUrl.searchParams.set('test_param', 'test_value');
            testUrl.searchParams.set('another_param', '123');

            window.history.replaceState({}, document.title, testUrl.toString());

            const pollutedUrl = window.location.href;

            // Clean URL
            if (window.stateManager && window.stateManager.cleanUrl) {
                window.stateManager.cleanUrl();
            }

            const cleanedUrl = window.location.href;
            const wasClean = new URL(cleanedUrl).search === '';

            resultsDiv.innerHTML = `
                <strong>URL cleaning test:</strong><br>
                Original: ${originalUrl}<br>
                Polluted: ${pollutedUrl}<br>
                Cleaned: ${cleanedUrl}<br>
                Successfully cleaned: ${wasClean ? 'Yes' : 'No'}
            `;
        }

        function simulateOldUrlPatterns() {
            const resultsDiv = document.getElementById('urlResults');

            // Simulate old URL patterns that should be cleaned
            const oldPatterns = [
                '?q=search+query&filter=type',
                '?id=123&action=edit',
                '?note=456&view=details&tab=content'
            ];

            const results = [];

            oldPatterns.forEach(pattern => {
                const testUrl = new URL(window.location.origin + window.location.pathname + pattern);
                window.history.replaceState({}, document.title, testUrl.toString());

                if (window.stateManager && window.stateManager.cleanUrl) {
                    window.stateManager.cleanUrl();
                }

                const isClean = new URL(window.location).search === '';
                results.push(`${pattern} ‚Üí ${isClean ? 'Clean' : 'Still has params'}`);
            });

            resultsDiv.innerHTML = `
                <strong>Old pattern simulation:</strong><br>
                ${results.join('<br>')}
            `;
        }

        function refreshStateDisplay() {
            const stateDiv = document.getElementById('currentState');

            if (window.stateManager) {
                const state = window.stateManager.getState();
                stateDiv.textContent = JSON.stringify(state, null, 2);
            } else {
                stateDiv.textContent = 'StateManager not available';
            }
        }

        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Starting URL Cleanup Test Suite');

            // Wait a bit for all scripts to load
            setTimeout(() => {
                testRunner.runTests();
                refreshStateDisplay();
            }, 1000);
        });
    </script>
</body>
</html>