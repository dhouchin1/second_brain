# Second Brain - Supervisor Configuration
# Process management for Gunicorn workers and background services

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisor/supervisord.pid
childlogdir=/var/log/supervisor/

[unix_http_server]
file=/var/run/supervisor/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:secondbrain-web]
command=/var/www/secondbrain/.venv/bin/gunicorn --config /var/www/secondbrain/deploy/gunicorn/gunicorn.conf.py app:app
directory=/var/www/secondbrain
user=www-data
group=www-data
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stopsignal=TERM
stdout_logfile=/var/log/secondbrain/supervisor_web_stdout.log
stderr_logfile=/var/log/secondbrain/supervisor_web_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=
    PATH="/var/www/secondbrain/.venv/bin:%(ENV_PATH)s",
    PYTHONPATH="/var/www/secondbrain",
    ENVIRONMENT="production"

[program:secondbrain-worker]
command=/var/www/secondbrain/.venv/bin/python -m celery --app=tasks.celery worker --loglevel=info --concurrency=4
directory=/var/www/secondbrain
user=www-data
group=www-data
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stopsignal=TERM
stdout_logfile=/var/log/secondbrain/supervisor_worker_stdout.log
stderr_logfile=/var/log/secondbrain/supervisor_worker_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=
    PATH="/var/www/secondbrain/.venv/bin:%(ENV_PATH)s",
    PYTHONPATH="/var/www/secondbrain",
    ENVIRONMENT="production"

[program:secondbrain-beat]
command=/var/www/secondbrain/.venv/bin/python -m celery --app=tasks.celery beat --loglevel=info
directory=/var/www/secondbrain
user=www-data
group=www-data
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stopsignal=TERM
stdout_logfile=/var/log/secondbrain/supervisor_beat_stdout.log
stderr_logfile=/var/log/secondbrain/supervisor_beat_stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=
    PATH="/var/www/secondbrain/.venv/bin:%(ENV_PATH)s",
    PYTHONPATH="/var/www/secondbrain",
    ENVIRONMENT="production"

[group:secondbrain]
programs=secondbrain-web,secondbrain-worker,secondbrain-beat
priority=999

[eventlistener:memmon]
command=/var/www/secondbrain/.venv/bin/memmon -a 200MB -m root@localhost
events=TICK_60
autostart=true
autorestart=true

[include]
files = /etc/supervisor/conf.d/*.conf