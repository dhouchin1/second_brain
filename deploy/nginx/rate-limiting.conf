# Second Brain - Rate Limiting Configuration
# Multi-tiered rate limiting for different endpoint types

# Define rate limiting zones
# General web traffic - 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# API endpoints - 20 requests per second per IP  
limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;

# Authentication endpoints - 5 requests per second per IP
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

# File upload endpoints - 2 requests per second per IP
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;

# Search endpoints - 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=search:10m rate=10r/s;

# Webhook endpoints - 5 requests per second per IP
limit_req_zone $binary_remote_addr zone=webhook:10m rate=5r/s;

# Connection limiting - max 10 concurrent connections per IP
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

# Status code for rate limiting responses
limit_req_status 429;
limit_conn_status 429;

# Custom error page for rate limiting
error_page 429 /429.html;

# Log rate limiting events
error_log /var/log/nginx/rate_limit.log warn;

# Rate limiting by user agent (block suspicious bots)
map $http_user_agent $limit_bots {
    default 0;
    ~*(bot|crawler|spider|scraper|curl|wget) 1;
}

limit_req_zone $limit_bots zone=bots:1m rate=1r/m;

# Whitelist for trusted IPs (e.g., monitoring, CDN)
geo $limit {
    default 1;
    # 127.0.0.1 0;  # Localhost
    # 10.0.0.0/8 0;  # Private networks
    # 192.168.0.0/16 0;
    # 172.16.0.0/12 0;
}

map $limit $limit_key {
    0 "";
    1 $binary_remote_addr;
}

# Apply connection limits globally
limit_conn conn_limit_per_ip 10;